{% extends 'base.html' %}
{% load l10n %}
{% load static %}

{% block title %}Nota de Serviço #{{ note.note_number }}{% endblock %}

{% block extra_style %}
<style>
    @media print {
        .navbar, .btn-action {
            display: none !important;
        }
        body {
            margin: 0;
            padding: 0;
            background-color: #fff;
        }
        .container {
            width: 100%;
            margin: 0;
            padding: 0;
        }
        img {
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
    }

    .section-box {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
        background-color: #fff;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075);
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="fw-bold text-primary">
            <i class="fas fa-file-invoice"></i> Nota de Serviço
        </h1>

        <!-- Botão de impressão corrigido -->
        <a href="{% url 'note_print' note.pk %}" target="_blank" class="btn btn-primary">Imprimir / PDF</a>
    </div>

    <div class="section-box text-center bg-light">
        <img src="{% static 'img/logo2.png' %}" alt="logo"
            style="height: 240px; width: auto; margin-bottom: 10px;">

        <p class="mb-1">CNPJ: 00.000.000/0001-00 | Endereço: Rua dos Pets, 123</p>

        <h3 class="mt-3 text-danger">Nº da Nota: {{ note.note_number }}</h3>
        <p class="text-muted">Data de Emissão: {{ note.issue_date|date:"d/m/Y H:i" }}</p>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="section-box">
                <h4 class="text-secondary border-bottom pb-2">Dados do Tutor</h4>
                <p><strong>Nome:</strong> {{ note.scheduling.tutor.name }}</p>
                <p><strong>CPF:</strong> {{ note.scheduling.tutor.cpf }}</p>
                <p><strong>Telefone:</strong> {{ note.scheduling.tutor.phone_number|default:"N/A" }}</p>
                <p><strong>Email:</strong> {{ note.scheduling.tutor.email|default:"N/A" }}</p>
            </div>
        </div>

        <div class="col-md-6">
            <div class="section-box">
                <h4 class="text-secondary border-bottom pb-2">Dados do Pet / Agendamento</h4>
                <p><strong>Nome do Pet:</strong> {{ note.scheduling.pet.name }}</p>
                <p><strong>Espécie/Raça:</strong> {{ note.scheduling.pet.species }} / {{ note.scheduling.pet.race|default:"N/A" }}</p>
                <p><strong>Data do Serviço:</strong>
                    <span class="badge bg-primary fs-6">{{ note.scheduling.date_scheduling|date:"d/m/Y" }}</span>
                </p>
                <p><strong>Status de Pagamento:</strong>
                    {% if note.scheduling.status == 'Sim' %}
                        <span class="badge bg-success">Pago</span>
                    {% else %}
                        <span class="badge bg-danger">Pendente</span>
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <div class="section-box">
        <h4 class="text-secondary border-bottom pb-2 mb-3">Serviços Executados</h4>
        <table class="table table-striped table-bordered mb-4">
            <thead>
                <tr>
                    <th style="width: 70%;">Serviço</th>
                    <th class="text-end">Preço Unitário (R$)</th>
                </tr>
            </thead>
            <tbody>
                {% for service in note.scheduling.services.all %}
                <tr>
                    <td>{{ service.name }}</td>
                    <td class="text-end">{{ service.price|localize }}</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    <th class="text-end">Valor Bruto Total:</th>
                    <th class="text-end text-primary">R$ {{ note.scheduling.gross_total_value|localize }}</th>
                </tr>
                <tr>
                    <th class="text-end">Desconto ({{ note.scheduling.percentage_discount }}%):</th>
                    <th class="text-end text-danger">- R$ {{ discount_amount|localize }}</th>
                </tr>
                <tr class="table-success">
                    <th class="text-end fs-5">VALOR TOTAL A PAGAR:</th>
                    <th class="text-end fs-5">R$ {{ note.scheduling.total_value|localize }}</th>
                </tr>
            </tfoot>
        </table>
    </div>

    {% if note.scheduling.observations %}
    <div class="section-box">
        <h4 class="text-secondary border-bottom pb-2">Observações</h4>
        <p>{{ note.scheduling.observations }}</p>
    </div>
    {% endif %}

    <div class="text-center mt-5 pt-3 border-top">
        <p class="small text-muted">
            Documento gerado eletronicamente em {{ note.issue_date|date:"d/m/Y" }}.
        </p>
    </div>

</div>
{% endblock %}
